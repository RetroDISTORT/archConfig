* Retro's emacs config

** Automatic Package Installer
   Also includes melpa
#+BEGIN_SRC emacs-lisp
    (require 'package)
    (setq package-archives '(("gnu" . "http://elpa.gnu.org/packages/")
			     ("melpa" . "https://melpa.org/packages/")
			     ("org" . "http://orgmode.org/elpa/")))
    (package-initialize)

  (eval-after-load 'gnutls
    '(add-to-list 'gnutls-trustfiles "/etc/ssl/cert.pem"))
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'async) ; required somewhat recently
    (package-install 'use-package))
  (eval-when-compile
    (require 'async)
    (require 'use-package))
  (setq use-package-always-ensure t) ; docs say this is deprecated but things break when it's not included

#+END_SRC
   
** Theme
#+BEGIN_SRC emacs-lisp
  (set-foreground-color "white")
#+END_SRC

** Backup and Autosave Files
#+BEGIN_SRC emacs-lisp
  (setq backup-directory-alist `(("." . "~/.saves")))
#+END_SRC   

** Programming mode settings
#+BEGIN_SRC emacs-lisp
   (use-package nlinum
     :hook  (prog-mode . nlinum-mode)
     :init  (setq nlinum-highlight-current-line t))
#+END_SRC

** Vterm
#+BEGIN_SRC emacs-lisp
   (use-package vterm)
#+END_SRC   

** Dashboard Setup
#+BEGIN_SRC emacs-lisp
  (use-package dashboard
    :ensure t
    :init 
	    (setq dashboard-items '((recents  . 5)))
	    (setq dashboard-set-navigator t)
	    (setq dashboard-startup-banner "~/Documents/images/chronoTrigger.png")
	    (setq dashboard-banner-logo-title "T H E R E  I S  A N  E M A C S  C O M M A N D  T O  D O  T H A T")
    :config
    (dashboard-setup-startup-hook))
#+END_SRC

** Text mode
#+BEGIN_SRC emacs-lisp
  (add-hook 'text-mode-hook 'column-number-mode)
#+END_SRC

** Babel
#+BEGIN_SRC emacs-lisp
(org-babel-do-load-languages
 'org-babel-load-languages '((python . t)
			     (C . t)))
#+END_SRC

** Magit
#+BEGIN_SRC emacs-lisp
(use-package magit
  :config
  (setq magit-restricted-git-config-tag "magit.restricted-branches")
  (setq magit-default-restricted-branches '("main" "master"))

  (defun magit-get-restricted-branches ()
    (sort (split-string (magit-git-string "config" magit-restricted-git-config-tag) " ")
	  (lambda (a b) 'string<)))

  (defun magit-restricted-branch-setup ()
    (setq magit-git-debug-old magit-git-debug)
    (setq magit-git-debug t)
    (when (not (magit-git-success "config" magit-restricted-git-config-tag))
      (magit-call-git "config" magit-restricted-git-config-tag (string-join magit-default-restricted-branches " ")))
    (setq magit-git-debug magit-git-debug-old))
  (advice-add 'magit-dispatch :before #'magit-restricted-branch-setup)

  (defun magit-branch-check ()
    (member (magit-get-current-branch) (magit-get-restricted-branches)))

  (defun magit-commit-branch-check (&optional args)
    (magit-restricted-branch-setup)
    (if (magit-branch-check)
	(progn
	  (magit-commit-assert args)
	  (let ((new-branch
		 (magit-read-string-ns
		  (format "%s is a restricted branch! Commit changes to new branch"
			  (magit-get-current-branch)))))
	    (if (or (string= new-branch "main"))
		(user-error "Error: Tried to commit arround a restricted branch!")
	      (progn
		(magit-stash-save "(auto) moving from restricted branch" t t nil t)
		(magit-branch-and-checkout new-branch (magit-get-current-branch))
		(magit-call-git "stash" "pop")
		(magit-stage-modified)
		))))))
  (advice-add 'magit-commit-create :before #'magit-commit-branch-check)

  (defun magit-push-branch-check (&optional args)
    (magit-restricted-branch-setup)
    (if (magit-branch-check)
	(user-error (format "Error: Not allowed to push to %s! If commits are pending, you may need to checkout and cherry-pick." (magit-get-current-branch)))))
  (advice-add 'magit-push-current-to-pushremote :before #'magit-push-branch-check)

  (defun magit-restricted-view ()
    (interactive)
    (message "Restricted branches: %s" (string-join (magit-get-restricted-branches) " ")))

  (defun magit-restricted-add ()
    (interactive)
    (let ((restricted-branches (magit-get-restricted-branches))
	  (target-branch (magit-read-branch "Branch to restrict")))
      (if (not (member target-branch restricted-branches))
	  (magit-call-git "config" magit-restricted-git-config-tag
			  (format "%s %s" (string-join restricted-branches " ") target-branch)))))

  (defun magit-restricted-remove ()
    (interactive)
    (let* ((restricted-branches (magit-get-restricted-branches))
	   (current-branch (magit-get-current-branch))
	   (target-branch (magit-completing-read "Branch to derestrict" restricted-branches
						 nil t nil nil (when (member current-branch restricted-branches) current-branch))))
      (magit-call-git "config" magit-restricted-git-config-tag
		      (format "%s" (string-join (remove target-branch restricted-branches) " ")))))

  (transient-define-prefix magit-restricted ()
    "View or modify restriction git attributes"
    ["Branches"
     ("v" "View Restrictions"     magit-restricted-view)
     ("a" "Add a Restriction"    magit-restricted-add)
     ("r" "Remove a Restriction" magit-restricted-remove)]
    (interactive)
    (transient-setup 'magit-restricted))

  (transient-append-suffix 'magit-dispatch "!"
    '("=" "Restrict" magit-restricted))
  
  :bind
  (:map magit-mode-map ("=" . magit-restricted)))
(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(package-selected-packages
   '(quelpa-use-package use-package bind-key quelpa async telega magit vterm rust-mode)))
(custom-set-faces
 ;; custom-set-faces was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 )
 #+END_SRC
